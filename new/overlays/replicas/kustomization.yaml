apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: ns-sourcegraph
resources:
  - ../../base/sourcegraph

replicas:
  - name: gitserver
    count: 5
  - name: sourcegraph-frontend
    count: 2

replacements:
  # IMPORTANT: This file is required when changing replica numbers for gitserver, searcher, symbols and indexer
  - path: sourcegraph-replicas.yaml

# INLINE OPTION:
# replacements:
# - source:
#     kind: StatefulSet
#     name: gitserver
#     fieldPath: spec.replicas
#   targets:
#     - select:
#         kind: Deployment
#         name: sourcegraph-frontend
#       fieldPaths:
#       - spec.template.spec.containers.[args=serve].env.[name=GITSERVER_REPLICA_NUMBER].value
#     - select:
#         kind: Deployment
#         name: sourcegraph-frontend
#       fieldPaths:
#       - spec.template.spec.initContainers.[args=up].env.[name=GITSERVER_REPLICA_NUMBER].value
# - source:
#     kind: StatefulSet
#     name: searcher
#     fieldPath: spec.replicas
#   targets:
#     - select:
#         kind: Deployment
#         name: sourcegraph-frontend
#       fieldPaths:
#       - spec.template.spec.containers.[args=serve].env.[name=SEARCHER_REPLICA_NUMBER].value
#     - select:
#         kind: Deployment
#         name: sourcegraph-frontend
#       fieldPaths:
#       - spec.template.spec.initContainers.[args=up].env.[name=SEARCHER_REPLICA_NUMBER].value
# - source:
#     kind: StatefulSet
#     name: symbols
#     fieldPath: spec.replicas
#   targets:
#     - select:
#         kind: Deployment
#         name: sourcegraph-frontend
#       fieldPaths:
#       - spec.template.spec.containers.[args=serve].env.[name=SYMBOLS_REPLICA_NUMBER].value
#     - select:
#         kind: Deployment
#         name: sourcegraph-frontend
#       fieldPaths:
#       - spec.template.spec.initContainers.[args=up].env.[name=SYMBOLS_REPLICA_NUMBER].value