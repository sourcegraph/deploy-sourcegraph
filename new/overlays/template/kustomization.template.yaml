apiVersion: deployment.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../base/sourcegraph
# DO NOT REMOVE: Handle updating endpoints configs for frontend
replacements:
- path: util/endpoints-update.yaml
configMapGenerator:
# DO NOT REMOVE: Handle updating env vars for frontend
- name: sourcegraph-frontend-env
  behavior: merge
  env: env/frontend.env
# DO NOT REMOVE: Handle updating configs using env vars for kustomize
- name: sourcegraph-kustomize-env
  behavior: merge
  env: config/overlay.config
##########################################################
# DO NOT MAKE ANY CHANGES ABOVE THIS LINE 
##########################################################
# This update namespace for all resources
# Add "components/namespace" to your components to create namespace
namespace: default
##########################################################
# GENERATE SECRETS
##########################################################
secretGenerator:
# Uncomment when using the tls component
- name: sourcegraph-frontend-tls
  behavior: create
  files:
  - env/tls.crt
  - env/tls.key
# Generate secrets for gitserver to use ssh
- name: gitserver-ssh
  files:
  - env/id_rsa
  - env/known_hosts
# Generate secrets for database
- name: dbs-secrets
  files:
  - env/secrets.env
##########################################################
# UPDATE REPLICA COUNTS
##########################################################
replicas:
- name: gitserver
  count: 1
- name: searcher
  count: 1
- name: symbols
  count: 1
- name: indexed-search
  count: 1
- name: gitserver
  count: 1
- name: sourcegraph-frontend
  count: 2
- name: precise-code-intel-worker
  count: 1
##########################################################
# UPDATE CONFIGMAP
##########################################################
patchesStrategicMerge:
- config/prometheus.ConfigMap.yaml
- config/pgsql.ConfigMap.yaml
- config/otel-collector.ConfigMap.yaml
- config/custom.NodePort.yaml
##########################################################
# UPDATE CONFIGMAP
##########################################################
patchesJson6902:
- target:
    version: v1
    kind: Ingress
    name: sourcegraph-frontend
  path: config/frontend-ingress.annotations.yaml
##########################################################
# COMPONENTS
##########################################################
components:
# Add resources for Sourcegraph monitoring stacks
# RBACs required
- ../../components/monitoring
# To enable TLS
# Add env vars below to config/overlay.config:
# - TLS_HOST
# - TLS_INGRESS_CLASS_NAME
# - TLS_CLUSTER_ISSUER
# Add tls.crt & tls.key to the config directory
# Then uncomment all TLS fields in "secretGenerator" section below
- ../../components/tls
# Use private-registry
# Add env vars below to config/overlay.config:
# - DEPLOY_SOURCEGRAPH_PRIVATE_REGISTRY
- ../../components/private-registry
# Disable or enable rockskip
- ../../components/disable/rockskip
- ../../components/enable/rockskip
# Create resources for using local SSDs - RBACs required
# Add env vars below to config/overlay.config:
# - SSD_NODE_PATH
- ../../components/ssd
# Use nodeport 30080
- ../../components/nodeport
# Remove all daemonsets resources
- ../../components/remove/daemonset
# Remove cadvisor
- ../../components/remove/cadvisor
# Remove the default ingress from frontend
- ../../components/remove/default-ingress
# Remove all pvcs resources
- ../../components/remove/pvcs
# Remove all container resources (Limits, requests)
- ../../components/remove/resources
# Update network-policy
# See docs
- ../../components/network-policy
# Use custom redis servers
# Add env vars below to env/frontend.env:
# - REDIS_CACHE_ENDPOINT
# - REDIS_STORE_ENDPOINT
- ../../components/redis
# Update replica counts
- ../../components/replica
# Use ssh to clon repositories
# Also see GENERATE SECRETS sections for importing ssh files
# Non-root user
- ../../components/ssh/non-root
# Root user
- ../../components/ssh/root
# Create storage class resources for cloud providers
# For aws
- ../../components/storage-class/aws
# For azure
- ../../components/storage-class/azure
# For gcp
- ../../components/storage-class/gcp
# For other cloud providers
# Add env vars below to config/overlay.config:
# - STORAGECLASS_NAME
# - STORAGECLASS_PROVISIONER
# - STORAGECLASS_PARAM_TYPE
- ../../components/storage-class/cloud
