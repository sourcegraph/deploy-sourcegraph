apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
resources:
- ../../../base/monitoring/otel-collector
patchesJson6902:
  - target:
      kind: StatefulSet|Deployment
      name: sourcegraph-frontend|github-proxy|gitserver|indexed-search|precise-code-intel-worker|repo-updater|searcher|symbols|worker
      group: apps
      version: v1
    # OTEL_AGENT_HOST must be defined before OTEL_EXPORTER_OTLP_ENDPOINT to substitute the node IP on which the DaemonSet pod instance runs in the latter variable
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OTEL_AGENT_HOST
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: http://$(OTEL_AGENT_HOST):4317
  - target:
      kind: StatefulSet
      name: indexed-search
      group: apps
      version: v1
    # OTEL_AGENT_HOST must be defined before OTEL_EXPORTER_OTLP_ENDPOINT to substitute the node IP on which the DaemonSet pod instance runs in the latter variable
    patch: |-
      - op: add
        path: /spec/template/spec/containers/1/env/-
        value:
          name: OTEL_AGENT_HOST
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: http://$(OTEL_AGENT_HOST):4317