apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
secretGenerator:
- name: sourcegraph-tls
  files:
    - "../../userfiles/tls.crt"
    - "../../userfiles/tls.key"
  type: "kubernetes.io/tls"
generatorOptions:
  disableNameSuffixHash: true
patchesStrategicMerge:
  - |-
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: sourcegraph-frontend
    spec:
      tls:
      - hosts:
        - $(TLS_HOST)
        secretName: sourcegraph-tls
      rules:
        - host: $(TLS_HOST)
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: sourcegraph-frontend
                  port:
                    number: 30080
patchesJson6902:
- target:
    name: sourcegraph-tls
    kind: Secret
  patch: |-
    - op: replace
      path: /metadata/labels
      value: { "deploy": "sourcegraph" }
vars:
  - name: TLS_HOST
    objref:
      kind: ConfigMap
      name: vars
      apiVersion: v1
    fieldref:
      fieldPath: data.TLS_HOST
