apiVersion: batch/v1
kind: Job
metadata:
  name: migrator
  annotations:
    description: Database migrator for Postgres databases
  labels:
    app.component.kubernetes/component: migrator
    deploy: sourcegraph
spec:
  template:
    spec:
      containers:
      - name: migrator
        image: "index.docker.io/sourcegraph/migrator:4.2.0@sha256:d816e125395e99d8a25564f5a799f0e9bedf7c6230065619849e169d0865a35e"
        args: ["up"]
        env:
          - name: PGHOST
            value: "pgsql"
          - name: PGPORT
            value: "5432"
          - name: PGUSER
            value: "sg"
          - name: PGPASSWORD
            value: "sg"
          - name: PGDATABASE
            value: "sg"
          - name: PGSSLMODE
            value: "disable"
          - name: CODEINTEL_PGHOST
            value: "codeintel-db"
          - name: CODEINTEL_PGPORT
            value: "5432"
          - name: CODEINTEL_PGUSER
            value: "sg"
          - name: CODEINTEL_PGPASSWORD
            value: "sg"
          - name: CODEINTEL_PGDATABASE
            value: "sg"
          - name: CODEINTEL_PGSSLMODE
            value: "disable"
          - name: CODEINSIGHTS_PGHOST
            value: "codeinsights-db"
          - name: CODEINSIGHTS_PGPORT
            value: "5432"
          - name: CODEINSIGHTS_PGUSER
            value: "postgres"
          - name: CODEINSIGHTS_PGPASSWORD
            value: "password"
          - name: CODEINSIGHTS_PGDATABASE
            value: "postgres"
          - name: CODEINSIGHTS_PGSSLMODE
            value: "disable"
        resources:
          limits:
            cpu: 500m
            memory: 100M
          requests:
            cpu: 100m
            memory: 50M
      restartPolicy: OnFailure
  backoffLimit: 4
