apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    description: Stores clones of repositories to perform Git operations.
    kubectl.kubernetes.io/default-container: gitserver
  labels:
    app.kubernetes.io/component: gitserver
    deploy: sourcegraph
    sourcegraph-resource-requires: no-cluster-admin
  name: gitserver
  namespace: sourcegraph
spec:
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: gitserver
  serviceName: gitserver
  template:
    metadata:
      labels:
        app: gitserver
        deploy: sourcegraph
        group: backend
        type: gitserver
    spec:
      containers:
        - args:
            - run
          env:
            - name: SRC_ENABLE_GC_AUTO
              value: "false"
          image: index.docker.io/sourcegraph/gitserver:3.34.1@sha256:db8bcdf3f07f3d4ab4262f41dd11853f62811bd3a4e5e981802ddc3dee3a0af1
          livenessProbe:
            initialDelaySeconds: 5
            tcpSocket:
              port: rpc
            timeoutSeconds: 5
          name: gitserver
          ports:
            - containerPort: 3178
              name: rpc
          resources:
            limits:
              cpu: "8"
              memory: 8G
            requests:
              cpu: "4"
              memory: 4G
          terminationMessagePolicy: FallbackToLogsOnError
          volumeMounts:
            - mountPath: /data/repos
              name: repos
        - args:
            - --reporter.grpc.host-port=jaeger-collector:14250
            - --reporter.type=grpc
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
          image: index.docker.io/sourcegraph/jaeger-agent:3.34.1@sha256:0e7c12cfe26f48b368852eb42dbcccf36ce798b2c8261f71ab67be088c363f11
          name: jaeger-agent
          ports:
            - containerPort: 5775
              protocol: UDP
            - containerPort: 5778
              protocol: TCP
            - containerPort: 6831
              protocol: UDP
            - containerPort: 6832
              protocol: UDP
          resources:
            limits:
              cpu: "1"
              memory: 500M
            requests:
              cpu: 100m
              memory: 100M
      securityContext:
        runAsUser: 0
      volumes:
        - name: repos
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
    - metadata:
        name: repos
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Ti
        storageClassName: sourcegraph-storage-class
